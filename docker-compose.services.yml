version: '3.8'

# This compose file is compatible with both docker-compose and podman-compose
# AMI-ORCHESTRATOR uses Podman by default for enhanced security and rootless containers

services:
  # Meta search engine
  searxng:
    image: searxng/searxng:latest
    container_name: ami-searxng
    depends_on:
      - searxng-redis
    environment:
      BASE_URL: ${SEARXNG_BASE_URL:-http://127.0.0.1:8888}
      SEARXNG_SECRET: ${SEARXNG_SECRET:-change-me}
      REDIS_URL: ${SEARXNG_REDIS_URL:-redis://searxng-redis:6379/0}
      LIMITER: ${SEARXNG_LIMITER:-true}
    ports:
      - "${SEARXNG_PORT:-8888}:8080"
    volumes:
      - ./launcher/config/searxng/settings.yml:/etc/searxng/settings.yml:ro

  # Dedicated Redis for SearXNG
  searxng-redis:
    image: redis:7-alpine
    container_name: ami-searxng-redis
    command: ["redis-server", "--save", "", "--appendonly", "no"]
    volumes:
      - searxng_redis_data:/data

  # Password manager
  vaultwarden:
    image: vaultwarden/server:1.32.3
    container_name: ami-vaultwarden
    environment:
      DOMAIN: ${VAULTWARDEN_DOMAIN:-http://127.0.0.1:${VAULTWARDEN_PORT:-8083}}
      ROCKET_ADDRESS: 0.0.0.0
      ROCKET_PORT: 80
      SIGNUPS_ALLOWED: ${VAULTWARDEN_SIGNUPS_ALLOWED:-false}
      INVITATIONS_ALLOWED: ${VAULTWARDEN_INVITATIONS_ALLOWED:-false}
      WEBSOCKET_ENABLED: ${VAULTWARDEN_WEBSOCKET_ENABLED:-true}
    ports:
      - "${VAULTWARDEN_PORT:-8083}:80"
    volumes:
      - vaultwarden_data:/data

  # VPN entrypoint
  openvpn:
    image: ghcr.io/linuxserver/openvpn-as:2.13.1
    container_name: ami-openvpn
    cap_add:
      - NET_ADMIN
    environment:
      PUID: ${OPENVPN_PUID:-1000}
      PGID: ${OPENVPN_PGID:-1000}
      TZ: ${OPENVPN_TZ:-UTC}
      INTERFACE: ${OPENVPN_INTERFACE:-eth0}
    ports:
      - "${OPENVPN_TCP_PORT:-943}:943"
      - "${OPENVPN_ADMIN_PORT:-9443}:9443"
      - "${OPENVPN_UDP_PORT:-1194}:1194/udp"
    volumes:
      - openvpn_config:/config

  # Matrix (Synapse) homeserver - ISMS communications backbone
  matrix-synapse:
    image: matrixdotorg/synapse:v1.95.0
    container_name: ami-matrix-synapse
    depends_on:
      - matrix-postgres
    environment:
      SYNAPSE_CONFIG_PATH: /data/homeserver.yaml
      UID: ${MATRIX_UID:-991}
      GID: ${MATRIX_GID:-991}
    volumes:
      - matrix_synapse_data:/data
      - ./streams/config/matrix/element-config.json:/app/config.json:ro  # Element config for web client
    ports:
      - "${MATRIX_HTTP_PORT:-8008}:8008"
      - "${MATRIX_FEDERATION_PORT:-8448}:8448"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8008/health"]
      interval: 5s
      timeout: 3s
      retries: 2
      start_period: 10s
    networks:
      - ami-isms

  # Matrix PostgreSQL database
  matrix-postgres:
    image: postgres:15-alpine
    container_name: ami-matrix-postgres
    environment:
      POSTGRES_DB: ${MATRIX_POSTGRES_DB:-synapse}
      POSTGRES_USER: ${MATRIX_POSTGRES_USER:-synapse}
      POSTGRES_PASSWORD: ${MATRIX_POSTGRES_PASSWORD}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    volumes:
      - matrix_postgres_data:/var/lib/postgresql/data
    ports:
      - "${MATRIX_POSTGRES_PORT:-5433}:5432"  # Non-conflicting port
    networks:
      - ami-isms

  # Element Web - Matrix web client for ISMS users
  matrix-element:
    image: vectorim/element-web:v1.11.52
    container_name: ami-matrix-element
    depends_on:
      - matrix-synapse
    volumes:
      - ./streams/config/matrix/element-config.json:/app/config.json:ro
    ports:
      - "${MATRIX_ELEMENT_PORT:-8889}:80"
    networks:
      - ami-isms

volumes:
  searxng_redis_data:
  vaultwarden_data:
  openvpn_config:
  matrix_synapse_data:
  matrix_postgres_data:

networks:
  ami-isms:
    driver: bridge
    name: ami-isms-network
