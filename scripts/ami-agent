#!/usr/bin/env bash
# ami-agent: Wrapper for scripts/automation/agent_main.py
# Always uses root venv since automation/ is under scripts/
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"

# Load required CLI versions from .env (safe parsing, no sourcing)
CLAUDE_REQUIRED_VERSION="2.0.10"
GEMINI_REQUIRED_VERSION="0.11.3"
if [ -f "$ROOT_DIR/.env" ]; then
    while IFS='=' read -r key value; do
        # Skip comments and empty lines
        [[ "$key" =~ ^#.*$ ]] && continue
        [[ -z "$key" ]] && continue

        if [ "$key" = "CLAUDE_CLI_VERSION" ]; then
            CLAUDE_REQUIRED_VERSION="$value"
        elif [ "$key" = "GEMINI_CLI_VERSION" ]; then
            GEMINI_REQUIRED_VERSION="$value"
        fi
    done < "$ROOT_DIR/.env"
fi

# Check Claude CLI version
check_claude_version() {
    local claude_path="$1"

    if [ ! -x "$claude_path" ]; then
        return 1
    fi

    local current_version
    current_version=$("$claude_path" --version 2>/dev/null | awk '{print $1}')

    if [ "$current_version" != "$CLAUDE_REQUIRED_VERSION" ]; then
        return 2
    fi

    return 0
}

# Install Claude CLI using bootstrapped npm from venv (non-interactive)
install_claude_cli() {
    local npm_bin="$ROOT_DIR/.venv/bin/npm"

    if [ ! -f "$npm_bin" ]; then
        echo "Error: npm not found in venv. Run module_setup.py first to bootstrap Node.js." >&2
        return 1
    fi

    echo "Installing Claude CLI version $CLAUDE_REQUIRED_VERSION to venv..." >&2
    if "$npm_bin" install --prefix "$ROOT_DIR/.venv" "@anthropic-ai/claude-code@$CLAUDE_REQUIRED_VERSION"; then
        echo "✓ Successfully installed Claude CLI $CLAUDE_REQUIRED_VERSION to .venv/node_modules/" >&2
        return 0
    else
        echo "✗ Failed to install Claude CLI" >&2
        return 1
    fi
}

# Enforce venv-only Claude CLI (no system fallback)
CLAUDE_BIN="$ROOT_DIR/.venv/node_modules/.bin/claude"

# Auto-install if not present
if [ ! -x "$CLAUDE_BIN" ]; then
    echo "Claude CLI not found in venv, installing version $CLAUDE_REQUIRED_VERSION..." >&2
    if ! install_claude_cli; then
        echo "Error: Failed to install Claude CLI to venv" >&2
        echo "Run: module_setup.py to bootstrap Node.js first" >&2
        exit 1
    fi
fi

# Verify binary exists after installation
if [ ! -x "$CLAUDE_BIN" ]; then
    echo "Error: Claude CLI installation completed but binary not found at:" >&2
    echo "  $CLAUDE_BIN" >&2
    exit 1
fi

# Verify version matches requirement
if ! check_claude_version "$CLAUDE_BIN"; then
    ret=$?
    if [ $ret -eq 2 ]; then
        current=$("$CLAUDE_BIN" --version 2>/dev/null | awk '{print $1}')
        echo "Claude CLI version mismatch. Required: $CLAUDE_REQUIRED_VERSION, Found: $current" >&2
        echo "Reinstalling correct version..." >&2

        if ! install_claude_cli; then
            echo "Error: Failed to install correct Claude CLI version" >&2
            exit 1
        fi

        # Re-verify after reinstall
        if ! check_claude_version "$CLAUDE_BIN"; then
            echo "Error: Version check still fails after reinstall" >&2
            exit 1
        fi
    else
        echo "Error: Claude CLI check failed" >&2
        exit 1
    fi
fi

# === Gemini CLI Bootstrap ===

# Check Gemini CLI version
check_gemini_version() {
    local gemini_path="$1"

    if [ ! -x "$gemini_path" ]; then
        return 1
    fi

    local current_version
    current_version=$("$gemini_path" --version 2>/dev/null | grep -oP '^\d+\.\d+\.\d+')

    if [ "$current_version" != "$GEMINI_REQUIRED_VERSION" ]; then
        return 2
    fi

    return 0
}

# Install Gemini CLI using bootstrapped npm from venv (non-interactive)
install_gemini_cli() {
    local npm_bin="$ROOT_DIR/.venv/bin/npm"

    if [ ! -f "$npm_bin" ]; then
        echo "Error: npm not found in venv. Run module_setup.py first to bootstrap Node.js." >&2
        return 1
    fi

    echo "Installing Gemini CLI version $GEMINI_REQUIRED_VERSION to venv..." >&2
    if "$npm_bin" install --prefix "$ROOT_DIR/.venv" "@google/gemini-cli@$GEMINI_REQUIRED_VERSION"; then
        echo "✓ Successfully installed Gemini CLI $GEMINI_REQUIRED_VERSION to .venv/node_modules/" >&2
        return 0
    else
        echo "✗ Failed to install Gemini CLI" >&2
        return 1
    fi
}

# Enforce venv-only Gemini CLI (optional, no system fallback)
GEMINI_BIN="$ROOT_DIR/.venv/node_modules/.bin/gemini"

# Note: Gemini is optional, only required if automation.yaml uses cli_agent.type: gemini
if [ ! -x "$GEMINI_BIN" ]; then
    echo "Note: Gemini CLI not found in venv (optional)." >&2
    echo "Only required if automation.yaml uses cli_agent.type: gemini" >&2
else
    # Verify version if present
    if ! check_gemini_version "$GEMINI_BIN"; then
        ret=$?
        if [ $ret -eq 2 ]; then
            current=$("$GEMINI_BIN" --version 2>/dev/null | grep -oP '^\d+\.\d+\.\d+')
            echo "Warning: Gemini CLI version mismatch. Required: $GEMINI_REQUIRED_VERSION, Found: $current" >&2
            echo "Note: Mismatched version may cause issues if used by automation" >&2
        else
            echo "Warning: Gemini CLI check failed" >&2
        fi
    fi
fi

# Force root venv for scripts/automation/agent_main.py - it requires root dependencies
exec "$ROOT_DIR/.venv/bin/python" "$SCRIPT_DIR/automation/agent_main.py" "$@"
