#!/usr/bin/env bash
# ami-agent: Wrapper for scripts/agents/cli/main.py
# Always uses root venv since agents/ is under scripts/
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(dirname "$SCRIPT_DIR")"

# Check for version argument
if [[ "$*" == *"-v"* ]] || [[ "$*" == *"--version"* ]]; then
    # Only do basic existence checks for version display
    export DISABLE_AUTOUPDATER=1

    # Enforce venv-only Claude CLI (no system alternative)
    CLAUDE_BIN="$ROOT_DIR/.venv/node_modules/.bin/claude"

    # FAIL if Claude CLI is not present - install must be properly run
    if [ ! -x "$CLAUDE_BIN" ]; then
        echo "Error: Claude CLI not found at $CLAUDE_BIN" >&2
        echo "Run: ./install to install Node.js CLI agents properly" >&2
        exit 1
    fi

    # Just display version without checking interoperability
    echo "Claude CLI Version: $($CLAUDE_BIN --version 2>/dev/null || echo "Unable to determine")"

    # Set Claude configuration to disable updates
    if [ -x "$CLAUDE_BIN" ]; then
        "$CLAUDE_BIN" config set -g autoUpdates disabled 2>/dev/null || true
    fi

    # === Gemini CLI Bootstrap ===

    # Enforce venv-only Gemini CLI (no system alternative)
    GEMINI_BIN="$ROOT_DIR/.venv/node_modules/.bin/gemini"

    # FAIL if Gemini CLI is not present - install must be properly run
    if [ ! -x "$GEMINI_BIN" ]; then
        echo "Error: Gemini CLI not found at $GEMINI_BIN" >&2
        echo "Run: ./install to install Node.js CLI agents properly" >&2
        exit 1
    fi

    # Just display version without checking interoperability
    echo "Gemini CLI Version: $($GEMINI_BIN --version 2>/dev/null || echo "Unable to determine")"

    # Configure Gemini CLI to use "Login with Google" free tier OAuth
    export GOOGLE_GENAI_USE_GCA=true

    # Validate auth configuration
    if [ "${GOOGLE_GENAI_USE_GCA}" != "true" ]; then
        echo "Error: GOOGLE_GENAI_USE_GCA must be set to 'true'" >&2
        exit 1
    fi

    # Set default location (optional, not required for free tier but safe to have)
    if [ -z "${GOOGLE_CLOUD_LOCATION:-}" ]; then
        export GOOGLE_CLOUD_LOCATION="us-central1"
    fi
else
    # Normal operation - just check if CLAUDE_BIN exists, don't run version check
    CLAUDE_BIN="$ROOT_DIR/.venv/node_modules/.bin/claude"
    if [ ! -x "$CLAUDE_BIN" ]; then
        echo "Error: Claude CLI not found at $CLAUDE_BIN" >&2
        echo "Run: ./install to install Node.js CLI agents properly" >&2
        exit 1
    fi

    # Set Claude configuration to disable updates (without version check)
    if [ -x "$CLAUDE_BIN" ]; then
        "$CLAUDE_BIN" config set -g autoUpdates disabled 2>/dev/null || true
    fi

    # Gemini binary check (without version check)
    GEMINI_BIN="$ROOT_DIR/.venv/node_modules/.bin/gemini"
    if [ ! -x "$GEMINI_BIN" ]; then
        echo "Error: Gemini CLI not found at $GEMINI_BIN" >&2
        echo "Run: ./install to install Node.js CLI agents properly" >&2
        exit 1
    fi

    # Set up basic environment without full authentication check
    export DISABLE_AUTOUPDATER=1
    export GOOGLE_GENAI_USE_GCA=true
fi

# Force root venv for scripts/agents/cli/main.py - it requires root dependencies
exec "$ROOT_DIR/.venv/bin/python" "$SCRIPT_DIR/agents/cli/main.py" "$@"